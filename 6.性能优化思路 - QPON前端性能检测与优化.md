(web.dev)[https://web.dev/articles/lcp?hl=zh_cn]



# 零、前言
本文主要探讨网页前端性能优化的四个关键步骤：量化、诊断、优化和监控页面性能。
- 量化：通过网页核心指标（Core Web Vitals）量化当前页面性能。
- 诊断：利用性能诊断工具和用户数据分析发现性能瓶颈和优化机会。
- 优化：针对问题进行优化，并比较优化前后的性能指标。
- 监控：使用自动化工具进行持续性能监控，防止性能回归和劣化。
基于Google的性能指标，通过系统性的分析对网页性能和体验进行优化，以实现有条不紊、循序渐进的性能检测与优化。

# 一、背景
## 1.用户环境
qpon主要面向海外印尼地区的用户，此部分地区用户的设备性能和网络状况相较于国内会差很多，因此对网页加载速度的感知会更明显。

## 2.必要性
2.1 减少用户流失
Think with Google报告指出，页面加载时长与用户流失率有密切关系，当加载时长从1秒增加到5秒，用户跳出率会增加90%。

- ![](https://p9-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/d06d94193db74560a64a04ce105059f3.png~tplv-a9rns2rl98-image.png?rcl=20260105103513F32E327AAE06A84B83E3&rk3s=8e244e95&rrcfp=dafada99&x-expires=2083804513&x-signature=cbuoVByX5RRApBkUW7V2y4hyCZU%3D)

缓慢的页面加载时长在影响用户体验的同时也非常考验用户的耐心，每增加一秒加载时长意味着消磨着用户的耐心和增加用户的跳出率，即使再有耐心的用户也会因为迟迟加载不出页面而选择离开。

## 2.2 SEO优化
Google官方一直在鼓励网页给用户带来更好的体验，为此将一些衡量网页性能的指标纳入到其搜索引擎排名算法中，以奖励那些交互友好和给用户带来更好体验的页面，为其带来更大的流量潜力。

## 2.3 用户体验
用户体验友好的页面可以提高用户会话数、停留时长，为用户带来愉悦的体验的同时也提高了用户粘性，为提高用户转化率带来更多的可能。
因此，为减少页面加载时长，提高用户体验，降低用户流失率，需要对页面的用户体验和性能进行针对性地优化。



# 二、基本流程
## 0. 一句话概括
量化->诊断->优化->监控
- 用量化指标来衡量当前页面性能
- 通过诊断分析工具或采集统计用户数据来发现当前页面的性能问题或瓶颈
- 基于问题进行针对性的优化，比对优化前后的性能指标差异
- 通过工具实现可持续的性能监控，防止性能回归或劣化

![](https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/a561e79431964b15a2fc090493f4b8f0.png~tplv-a9rns2rl98-image.png?rcl=2026010510374200AA21782BEE5A3FD0A4&rk3s=8e244e95&rrcfp=dafada99&x-expires=2083804663&x-signature=cly7WOWfoQd%2FqhEZJowXhOL8dyQ%3D)


### 1.量化
#### 1.1 介绍
通过可量化的指标来评估和衡量页面的性能和体验，以获得对当前页面性能的基本了解。之后可以基于页面性能指标进行针对性地优化，通过比对各项指标是否有真实的提升。

#### 1.2 Core Web Vitals
##### 1.2.1 介绍
Google提供了一组web页面性能指标：Core Web Vitals（核心网页指标），Core Web Vitals的指标并不是一成不变的，会随着时间的推移而改变，例如2024年3月INP替代FID成为新的核心指标。
截止至2024.12.01的这组指标分别为LCP（最大内容绘制时间）,INP（交互到下一帧绘制的时间）,CLS（累积布局偏移），分别对应用户体验的三个方面：加载速度，互动性，视觉稳定性。根据页面加载速度、用户输入的响应延迟、网页布局偏移来衡量网页的性能与体验。

![](https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/ec9f384383cf446cbc16401363343f5b.png~tplv-a9rns2rl98-image.png?rcl=202601051041411630CC6DB38F1FCE2217&rk3s=8e244e95&rrcfp=dafada99&x-expires=2083804901&x-signature=gFortjFhWfvuZ3fdPerCtCCNhks%3D)

##### 1.2.2 Largest Contentful Paint (LCP)
![](https://p9-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/f0fc51619ef945758743ea21618e0cc1.png~tplv-a9rns2rl98-image.png?rcl=202601051042298FF860288123E6D7AE55&rk3s=8e244e95&rrcfp=dafada99&x-expires=2083804949&x-signature=V5bqWrPh4R2w1mXi8SLzUvF2sEE%3D)

###### 1.2.2.1 作用
视图内最大内容的绘制渲染时间，用于衡量网页主要内容加载速度。

###### 1.2.2.2 重要性
- 反映加载速度
是影响用户对网页加载速度感知的重要因素，可真实反映用于对网页加载速度的直观感受。
也是研发衡量网页加载速度的重要指标，帮助研发识别影响页面性能的关键资源。

- 影响SEO排名
同时，Google将LCP指标纳入到其搜索引擎排名算法中，较低的LCP意味着较低的搜索引擎排名，会影响网页SEO（Search Engine Optimization）。

- 混合开发时，可帮助优化移动设备的内存使用和电流消耗
优化LCP通常会拆分和压缩资源，拆分复杂的长任务，减少不必要的重绘和重排操作等，可降低CPU的功耗和内存使用，以减少移动设备（Android或ios）的电流消耗。

###### 1.2.2.3 统计方式
网页通常分阶段加载，因此网页上最大内容可能会发生变化。开始加载页面时浏览器会将绘制的第一帧识别为最大内容元素。在渲染后续帧时，浏览器会将更大的内容识别成最大内容元素，直到用户开始与页面进行互动才会停止记录。因此从 页面加载起点 到 图片绘制完成 的时间即LCP。

###### 1.2.2.4 示例
下图会标记页面在不同时间段的最大内容是哪个元素，开始时将绘制的第一张识别为最大内容元素。页面开始加载渲染文本块时，最大内容变成了文本块。随着页面加载，最大内容变成了紫色的图片，因此LCP是网页加载到此图片绘制完成的时间。

![](https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/4ba6ea773def47528cf91c8a6d4946f1.png~tplv-a9rns2rl98-image.png?rcl=2026010510495558465E12835F77A62DE5&rk3s=8e244e95&rrcfp=dafada99&x-expires=2083805395&x-signature=qoSUTU5ib8l7a1YLdgibnk6%2F9jI%3D)

##### 1.2.3 Cumulative Layout Shift (CLS)：
![](https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/72ce1f459fad4385ac3932364748ac55.png~tplv-a9rns2rl98-image.png?rcl=202601051051575B1386E2E3FC05BCC527&rk3s=8e244e95&rrcfp=dafada99&x-expires=2083805518&x-signature=J7sGv4qJAqGaVfCCZPrpFDJoGus%3D)

###### 1.2.3.1 作用
累积布局偏移，该指标用于统计网页加载时的元素意外偏移的累计分数。布局偏移是影响用户体验的重要指标，较高的布局偏移分数会影响用户的体验。

###### 1.2.3.2 重要性
越高的布局偏移意味着页面元素的抖动比较明显，用户非常容易误触页面，导致意外的交互发生，影响用户体验的同时也有可能导致用户的流失。

###### 1.2.3.3示例
举个例子，如下图所示，当某个用户在网页加载时想要点击下单按钮，却因为意外的布局偏移和页面抖动导致误触了其他元素，导致影响用户体验的同时可能也导致了订单的流失。

![](https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/cd353d516d07477688e9db03cdffcb7c.png~tplv-a9rns2rl98-image.png?rcl=20260105111739D3CE67813D8A4040FD2D&rk3s=8e244e95&rrcfp=dafada99&x-expires=2083807059&x-signature=o5DZmFrp8eRC1Uvg1eSyf6Ka44o%3D)

一个交互友好，对用户友好的页面应当尽可能地避免意外的布局偏移，例如为可能导致布局偏移的元素提前预留空间和位置。如下图所示，为加载时间较长的图片预留空间，可以有效地防止用户误点击，后续的优化CLS思路也是遵循着这个思路。

![](https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/ed7322c71fa94b699e8aacd2d5cf97f2.png~tplv-a9rns2rl98-image.png?rcl=2026010511180830CA3024514731FCBDF8&rk3s=8e244e95&rrcfp=dafada99&x-expires=2083807088&x-signature=EvSXdmmdbJJfcClWge8Njv3nH1k%3D)

##### 1.2.4 Interaction to Next Paint (INP)：
![](https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/ed898a7508474ae1baaef6cff93f7d64.png~tplv-a9rns2rl98-image.png?rcl=20260105112035A4C9528EB2EF97CAB3B8&rk3s=8e244e95&rrcfp=dafada99&x-expires=2083807236&x-signature=eF%2B2gDifGn9HDkGeZf9d7zYMkqQ%3D)

###### 1.2.4.1 作用
交互到下一帧绘制的时间，就是用户在页面上执行交互操作（例如点击）到随后在屏幕的视觉更新或渲染的延迟时间，反映交互的响应延迟，说白了就是用来评价当前页面的交互丝滑与否。用于衡量页面对用户交互的响应速度。
如下图所示，左图的响应速度明显慢于右图，可通过INP直观反映两个页面之间的响应速度和交互流畅度。

![](https://web.dev/static/articles/inp/video/jL3OLOhcWUQDnR4XjewLBx4e3PC3/WSmcjiQC4lyLxGoES4dd.mp4?hl=zh-cn)

###### 1.2.4.2 重要性
- 响应能力
INP可以直观反映出网页的响应能力，越低的INP意味着越短的响应延迟时间和更快的响应速度，能够为用户带来更流畅、更丝滑的交互体验。

- SEO
Google也同样将INP纳入其搜索引擎排序算法中，越低的INP意味着更多的流量曝光潜力。

- 混合开发的页面流畅度
如果是混合开发，页面的INP指标会直观反映app的交互响应延迟和页面流畅度，会影响app在Android或ios的响应延迟和流畅度测试。

###### 1.2.4.3 示例
页面有个轮播图，点击按钮切换到下一张图片，从点击按钮到下一帧绘制的时间就是交互响应延迟时间，会影响INP指标。

![](https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/311c7406b18d4757b0939ad49a098ab1.png~tplv-a9rns2rl98-image.png?rcl=20260105112424825B1DAE65D1369C7537&rk3s=8e244e95&rrcfp=dafada99&x-expires=2083807465&x-signature=WKhXH1nZeiZE3pX%2FKVMiMrTXr5g%3D)

##### 1.2.5 小结
Google官方建议将第75个百分位数作为衡量阈值，即第75个百分位的数据可以反映大多数用户的平均指标值。如果三个核心指标的第75个百分位都到达了建议的目标，那么表示当前页面性能良好。后续的性能诊断和优化也是为了达到此目标而努力。

## 2.诊断
举个例子，如果将当前网页比喻成一个体检人员或病人，那么LCP,CLS,INP等指标就是体检人员的体验数据，直观反映的网页的”身体机能与健康情况“。性能诊断工具就像听诊器、X光机、CT扫描仪等工具，扫描和发现网页的"健康问题"。研发人员就像医生，持续观察和诊断页面”健康“问题，及时发现和“治疗”页面的性能问题。

![](https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/6bc51c387e10424ca10362ff55c497f9.png~tplv-a9rns2rl98-image.png?rcl=20260105112507F2CE8739DBE67464C8A1&rk3s=8e244e95&rrcfp=dafada99&x-expires=2083807508&x-signature=tjJGZ6pDOfSvhE%2FddA2GHL%2FEhSc%3D)





### 2.1 介绍
通过性能诊断工具或者采集统计用户真实数据来发现当前页面的性能存在的问题和可优化的机会。

### 2.2 分类
常见的工具分为两类：模拟和预设不同环境的实验室工具（例如lighthouse）和采集统计真实用户数据进行诊断分析的现场工具或平台（例如CrUX）。

#### 2.2.1 实验室工具
##### 2.2.1.1 介绍
通过模拟不同的网络环境和终端设备条件，结合主流的性能诊断工具，系统性地识别和分析开发环境中潜在的性能瓶颈及用户体验问题。

##### 2.2.1.2 工具
- Chrome 开发者工具
- lighthouse 灯塔
- PageSpeed Insights
- WebPageTest
##### 2.2.1.3 示例
例如，可以通过WebPageTest预设的设备、网速、地区等条件，测试该预设条件的页面性能，诊断出可能的问题和优化机会。
![](https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/0cd53623800e4184b5cd09e44cfe2368.png~tplv-a9rns2rl98-image.png?rcl=20260105113537B48A6EFF260416BE9A6D&rk3s=8e244e95&rrcfp=dafada99&x-expires=2083808137&x-signature=%2BpcW%2FSx%2BQeKZMj9RE0P6b%2BqA11g%3D)

#### 2.2.2 现场工具
##### 2.2.2.1 介绍
基于真实用户性能指标（real user monitoring，简称RUM）的采集与数据分析，深入洞察生产环境中的用户体验痛点，从而发掘具有实际价值的性能优化空间。
##### 2.2.2.2 工具
- Chrome 用户体验报告（CrUX）
- PageSpeed Insights
- Search Console（“Core Web Vitals”报告）
- web-vitals JavaScript 库

##### 2.2.2.3 示例
CrUX作为Google官方公开统计的性能数据集合，进入CrUX信息中心即可查询过去28天内的真实用户在chrome浏览器的性能数据分布情况。

![](https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/8cde469997144468affc95a1267f46e5.png~tplv-a9rns2rl98-image.png?rcl=202601051143579526E9241B7EF2E1731D&rk3s=8e244e95&rrcfp=dafada99&x-expires=2083808637&x-signature=qU5HI5fP%2BiKBQ3XwKkhmixvWcW4%3D)


#### 2.2.3 常见工具介绍
##### 2.2.3.1 chrome 用户体验报告(CrUX）
![](https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/a0bdf291e9d3459da18d8317f5962aa6.png~tplv-a9rns2rl98-image.png?rcl=20260105114433C5B4388547A5E5CAE4FE&rk3s=8e244e95&rrcfp=dafada99&x-expires=2083808673&x-signature=Sq1gbmQzXIuROUhXgYI5HOMUQig%3D)

是一套公开的实测数据，基于真实的chrome浏览器用户在过去28天内的实际访问数据，统计出core web vitals指标的分布情况（CrUX信息中心链接），可通过参考CrUX数据了解网站的页面性能概览和趋势。
![](https://p9-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/281b099462f84098b058915236d9bbb7.png~tplv-a9rns2rl98-image.png?rcl=20260105114516E0BD96EEFF3ACF4496DC&rk3s=8e244e95&rrcfp=dafada99&x-expires=2083808717&x-signature=AXYwoX66ydLd%2FQW6vDSDq2wudD0%3D)

在CrUX信息中心输入想要查询数据的网址
![](https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/c95a83879abf41c5bbfbe6b8fdd61b8a.png~tplv-a9rns2rl98-image.png?rcl=20260105114516E0BD96EEFF3ACF4496DC&rk3s=8e244e95&rrcfp=dafada99&x-expires=2083808717&x-signature=KK3GJdfdO%2BXxjqjgQ3er6iB0c%2FQ%3D)

即可查询出真实用户通过chrome浏览器访问该网址的core web vitals指标的百分位分布。

##### 2.2.3.2 灯塔lighthouse
![](https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/8c8ce86e45604228ad37a4b631868f69.png~tplv-a9rns2rl98-image.png?rcl=20260105141904DF5ED1A9E686EF0D630A&rk3s=8e244e95&rrcfp=dafada99&x-expires=2083817944&x-signature=Ru6hOumjxSJ9t7hqY0c7dQATjZ4%3D)

作为Google官方推出的性能诊断工具，lighthouse有chrome插件，node服务，可通过模拟设备（移动端或者PC端）、网速延迟（例如3G、4G等）这些预设的条件对页面进行性能诊断，生成性能测试报告，反馈当前页面的性能指标（metrics），诊断（diagnostics）出的性能和体验问题，以及可优化的机会（opportunities）。
例如WebPageTest,PageSpeed Insights等常见的性能诊断工具的底层都集成了lighthouse的性能诊断能力。
虽然没有使用真实的用户现场数据，但是通过预设条件进行诊断可以有助于本地开发时及时发现当前迭代版本带来的性能劣化，以及发现预设环境的性能优化机会。
同时，可以基于lighthouse-CI或者自动化测试工具将lighthouse诊断能力集成到CICD中，实现自动化诊断性能问题和发现性能优化机会。

##### 2.2.3.3 PageSpeed Insights(PSI)
![](https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/6d0a5dd0022048e9940278c2c5c1f669.png~tplv-a9rns2rl98-image.png?rcl=20260105142310D70FF919D23C6827690C&rk3s=8e244e95&rrcfp=dafada99&x-expires=2083818190&x-signature=I13%2FsR2KorS7LJULcnKBuZ3BUFw%3D)

与前两个工具不同的是，PageSpeed Insights集成了lighthouse在预设环境的性能诊断能力和CrUX采集的真实用户数据集合。既能发现网页在预设环境和条件的优化机会，也能帮助发现真实用户在生产环境的页面性能问题（诊断工具链接）。

##### 2.2.3.4 Real User Monitoring（RUM）
采集和埋点上报用户的核心指标数据（例如web-vitals），监控用户的性能指标数据，相较于CrUX更加灵活，数据更加全面，更有利于分析不同地区、网速、设备的用户的实际页面加载时长和用户体验。

#### 2.2.4 小结
通过实验室工具可以预设不同环境的页面性能，模拟弱网有助于发现和排查平时难以发现的性能瓶颈。通过现场工具采集真实的用户数据有助于了解用户的真实用户体验和页面性能分布情况，有利于发现真实用户遇到的性能问题和观察优化后的性能变化。两类工具相辅相成，共同推动页面性能问题的诊断和优化。

## 3.优化
基于性能诊断工具及真实用户监测数据（RUM）所发现的性能瓶颈与体验痛点，制定针对性的优化策略，以提升网页性能表现。
不同项目的性能问题和可优化机会不同，像WebPageTest,lighthouse,PageSpeedIngights等工具会提供诊断建议和优化机会，下文将基于core web vitals指标（LCP,CLS,INP）发现的常见性能问题进行优化。

### 3.1 LCP（加载速度）
#### 3.1.1 思路
![](https://p9-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/bc1aff02b42b4e2688e7b16e49a038d6.png~tplv-a9rns2rl98-image.png?lk3s=8e244e95&rcl=20260112183727B0823AE3F55EEEFF070A&rrcfp=dafada99&x-expires=2084438247&x-signature=vQWH%2FGIDWOptdVPxjPGiw3tMR7U%3D)

从以上瀑布图可以看出初始HTML文档和LCP资源加载和渲染时长是影响LCP指标的两个主要因素，LCP时间可以细分为以下四个部分：
- **到第一字节时长（Time To First Byte,TTFB）**
从发起请求到第一个字节响应到前端的时长
- **LCP资源加载延迟**
从受到第一个字节响应，到LCP资源开始加载的延迟时间
- **LCP资源加载时间**
LCP资源的请求和加载时间
- **LCP元素渲染时间**
LCP资源加载完成之后，LCP元素渲染所用时间

假设以上四个部分没有重叠，那么LCP就是这四个子部分之和。
![](https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/bbe2c2b9f2054c77a994bde68c24d563.png~tplv-a9rns2rl98-image.png?lk3s=8e244e95&rcl=20260112183957AA5E302DF076698B41D2&rrcfp=dafada99&x-expires=2084438397&x-signature=yEwEHM6ppsD6VA6gMgNe1PKa2VU%3D)

因此，优化LCP时间本质上就是优化和减少以上四个部分的时间。其中，Google统计的影响LCP的主要子部分是TTFB和LCP资源加载时间，正所谓打蛇打七寸，因此这两部分是优化LCP的主要机会。

#### 3.1.2 实践
##### 3.1.2.1 确保 LCP 资源尽早开始加载
如果LCP资源是JS动态添加到网页中或者CSS背景图，那么需要运行脚本或CSS文件才会开始加载此LCP资源，会导致LCP资源加载的延迟。

- **预加载LCP资源**

```html
<!-- Preload the LCP image with a high fetchpriority so it starts loading with the stylesheet. -->
<link rel="preload" fetchpriority="high" as="image" href="/path/demo.webp" type="image/webp">
```

在 HTML 中使用 <link rel="preload"> 标记预加载资源，那么在浏览器扫描HTML文档的时候就可以发现LCP资源和预加载，从而达到提前发现LCP资源的效果，降低资源加载延迟。

- **提高LCP资源的优先级**
即使浏览器能从HTML找到标记的LCP资源，也可能不会最高优先级加载，因为图片不是阻塞渲染资源。而且，LCP图片可能会因为设置了懒加载属性（loading="lazy"），或者有其他资源设置了更高的优先级，导致浏览器延迟加载LCP资源。
因此，需要通过设置fetchpriority="high"属性来提高优先级，告知浏览器需要优先加载LCP资源。示例如下:

```html
<img fetchpriority="high" src="/path/demo.webp">
```
因为请求资源的带宽是有限的，可通过降低某些资源的优先级来为关键资源提供更多的带宽。例如某些图片在首屏加载是不可见的或者轮播图的不可见图片，可降低其优先级。
```html
<img fetchpriority="low" src="/path/demo.webp">
```

- 小结
最理想情况的降低LCP资源加载延迟的状态如下，第一个资源与LCP资源同时加载。
![](https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/ce2cfd4e5cf242a8bf1a1b8b2b9966e7.png~tplv-a9rns2rl98-image.png?lk3s=8e244e95&rcl=20260112184032EE1179E72C8DD6F147DD&rrcfp=dafada99&x-expires=2084438433&x-signature=%2BQm%2BclZm%2FbUhZ%2B5rheVRo4bNVhQ%3D)

##### 3.1.2.2 减少元素渲染延迟
以下图为例，即使LCP资源已经加载好了，由于Stylesheet样式表的加载时间明显长于LCP加载时间，导致后续渲染流程都被阻塞

![](https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/3c5ec14ac7b04311a3845b1ef446e226.png~tplv-a9rns2rl98-image.png?lk3s=8e244e95&rcl=202601121841030CCA72737DC99AFC1C5B&rrcfp=dafada99&x-expires=2084438463&x-signature=FdlAuerCqNtZa9r6B4MwyMlwqoI%3D)

因此，需要减少样式表的加载时间，常见的优化样式表建议如下：
- **压缩样式表体积**
压缩样式表的体积，例如删除不必要的空格、缩进、换行符、注释等内容。例如webpack、vite等构建工具都会配有主流使用的css压缩工具，例如vite的PostCSS和esbuild。

- **移除无用冗余的样式表内容**
有些样式代码和规则其实并没有实际使用，那么在打包的时候就可以将其移除掉，例如vite可以通过vite-plugin-purgecss插件移除未使用的css。

- **服务端渲染SSR**
  ![](https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/06814c46994249caa6098798cd986fc2.png~tplv-a9rns2rl98-image.png?lk3s=8e244e95&rcl=202601121841190F068D557E61128D3F2C&rrcfp=dafada99&x-expires=2084438479&x-signature=vtGzVX6whNQ%2BcACVnavrwNj58Ds%3D)

即服务端渲染，即在服务器上运行客户端逻辑，响应完整的HTML文档请求。
主要优势在于图片资源可在HTML中找到，同时无需等待其他的JavaScript请求就可呈现页面内容。唯一的缺点就是需要额外的服务器处理时间，会导致TTFB的降低。但是由于服务器处理时间在研发人员的可控范围（配置服务器规格等），而用户的网络和设备不在可控范围，因此这种取舍是值得的。

- **路由懒加载**
对于SPA应用，每个路由对应一个页面，如果不做懒加载，会在首页加载时一次性加载所有资源，由于js资源的加载会阻塞首屏渲染，导致首屏加载很慢和影响用户体验。
因此，可以基于es6的import()实现路由懒加载，基于路由动态加载各个模块，动态加载的子模块在构建时会被拆分成单独的文件。在打开首屏或者某个路由时只会加载关键资源，非关键资源的加载被延迟，带宽竞争的减少使得LCP资源可以尽快加载。

如以下示例：
路由懒加载前的js初始体积：
![](https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/59c17b1ee49f4992a7346dd6595d2587.png~tplv-a9rns2rl98-image.png?lk3s=8e244e95&rcl=202601121847523B08B09B9C72AC60DEE5&rrcfp=dafada99&x-expires=2084438872&x-signature=t6Qevo73uGW4VTXvuTJIzxKHdtw%3D)

全部改成路由懒加载之后：
```js
const Home = () => import("@/views/home/index.vue");
// 其他懒加载的路由页面组件...

const routes = [
    {
       path: "/",
       name: "home",
       component: Home
    },
    // 其他懒加载的路由页面组件...
]
```

可以看到首页js资源拆成了app.js和home.js，体积是之前的23%左右。
![](https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/2188b8585fdc46fe83afe0ae63ef5a88.png~tplv-a9rns2rl98-image.png?lk3s=8e244e95&rcl=202601121847523B08B09B9C72AC60DEE5&rrcfp=dafada99&x-expires=2084438872&x-signature=NEuoHrIZ%2B00o7xgTAr%2Fv4mv3XJE%3D)

同样的，css资源也会随之拆分，体积也明显小于优化前的体积。

- **组件懒加载**
与路由懒加载类似，一些非关键组件，在首屏渲染的时候不会加载和渲染，可以通过import()动态加载组件，实现组件懒加载。
如以下代码所示，home页面通过懒加载popup组件，那么构建打包时会把popup单独拆成一个chunk，进一步减少首页js文件的体积大小。
```js
const popup = () => import('@/components/popup');
```

###### 3.1.2.3 尽可能缩短 LCP 资源的加载时间
在不牺牲质量的情况下，尽可能减少资源通过网络传输到用户设备所化的时间，主要分为以下四种方法：
##### 3.1.2.3.1 减少资源的传输距离
- **使用CDN（内容分发网络）**
通过CDN存储图片资源，那么请求CDN资源时会尽可能地寻找地理位置最近的服务器节点，可以有效减少资源的传输举例。并且CDN通常可以满足资源的压缩和裁剪需求。


###### 3.1.2.3.2 压缩资源大小
- **使用现代图片格式（webp或avif）**
相同清晰度的图片，webp与jpg和png相比，通常文件大小会减少25%-35%，有助于在保证图片清晰度的情况下压缩图片资源体积以提高性能。
YouTube和Facebook等网站的数据佐证了webp图片所带来的网页性能提升（数据来源：web.dev-使用WebP图片）：
- YouTube 发现，改用 WebP 缩略图后，网页加载速度提高了 10%。
- 当 Facebook 改用 WebP 后，JPEG 文件的文件大小缩减了 25-35%，PNG 文件的文件大小缩减了 80%。
而avif与webp相比，有着更强的图片压缩能力（参考资料：web.dev-使用AVIF压缩网站上的图片），但由于avif的兼容性不如webp，因此使用avif时要考虑到兼容性问题。

- **使用最佳图片大小（二倍图或三倍图）**
举个例子，某个图片的实际渲染宽高都是50px，但是却请求了实际宽高是5000px的图片，那么就会造成资源的浪费，有”杀鸡焉用牛刀“的既视感。一般使用两倍图或者三倍图就可以渲染出非常清晰的图片了，那么刚才举例的场景只需要请求实际宽高是50*3 = 150px的三倍图就足矣。

- **示例**
如果图片资源使用的是OPPO的CDN域名，那么可以通过配置url参数来配置图片的宽高和图片格式，代码示例如下：

```js
/**
 * 只支持具备实时压缩图片功能的CDN使用该功能
 *
 * width:   压缩后的图片宽度, 0代表自适应
 * quality: 压缩后的图片质量, 最大100
 * */
export const compressImg = (url: string | undefined, opts: { width?: number; height?: number; quality?: number }): string => {
  if (!url) {
    return '';
  }
  // 是否为oppo的cdn域名图片
  const isOppoImg = url.includes('qponmobile.com');
  if (!isOppoImg) return url;
  // 如果是，那么通过拼接参数来配置正确尺寸的图片
  const { width = 0, height = 0 } = opts;
  let size = '';
  width && (size += `,w_${width}`);
  height && (size += `,h_${height}`);
  return `${url}&x-amz-process=image/resize,m_fill${size}/format,webp`;
};
```

###### 3.1.2.3.3 减少LCP资源的带宽竞争
上文有提到，通过配置较高的fetchpriority可以告知浏览器尽早地加载此资源

###### 3.1.2.3.4 完全消除资源加载时间
听起来有点玄幻，为什么加载资源的时间可以被消除掉？其实就是通过合理的缓存策略将图片资源缓存起来。


如果前端项目是部署到服务器，那么可以通过配置NGINX使得响应header带上缓存相关的响应头，例如Cache-Control：
```js
server {
    ...
    location / {
        add_header    Cache-Control max-age=2592000;
    }
    
    ...
}
```

如果项目是静态部署，那么可以通过配置云平台接入服务的对应域名的API网关，给访问静态资源的路径path配置返回响应头
![](https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/99910a7aabb74085b210237e7d1e08b7.png~tplv-a9rns2rl98-image.png?lk3s=8e244e95&rcl=202601121847523B08B09B9C72AC60DEE5&rrcfp=dafada99&x-expires=2084438872&x-signature=J83YxmLSNbYY5p8UiOEJRv6W9RE%3D)
